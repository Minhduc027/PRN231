<div class="row">
    <div class="col-md-10">
        <h3 class="display-8">Salt requirement List</h3>
    </div>
    <div class="col-md-2 text-end">
        <button type="button" class="btn btn-primary" onclick="add();">
            Add
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr class="card-header">
                    <th class="card-title text-center">SaltId</th>
                    <th class="card-title text-center">RequiredSaltAmount</th>
                    <th class="card-title text-center">Notes</th>
                    <th class="card-title text-center">CreatedAt</th>
                    <th class="card-title text-center">Pond</th>
                    <th class="card-title text-center"></th>
                </tr>
            </thead>
            <tbody class="tblSatls">
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="saltModal" tabindex="-1" aria-labelledby="saltModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm(null, null, FormMethod.Post, new { name = "frm", id = "frm" }))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="saltModalLabel">Add New Salt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="saltRequirementId" name="saltRequirementId" />
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="requiredSaltAmount">RequiredSaltAmount</label>
                            <input type="number" id="requiredSaltAmount" name="requiredSaltAmount" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label for="note">Note</label>
                            <input type="text" id="note" name="note" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-4">
                            <label for="pond">Pond</label>
                            <select id="pond" name="pond" class="form-control">
                                <option value="">select pond</option> <!-- Tùy chọn mặc định -->
                            </select>
                            @* <input type="radio" id="pond" name="pond" class="form-control" /> *@
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btSave" type="button" class="btn btn-primary">Save</button>
                    <button id="btEdit" type="button" class="btn btn-primary">Edit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            }
        </div>
    </div>
</div>


@section scripts{
    <script type="text/javascript">
    $(document).ready(function () {
        loadData();
    });

        function loadData() {
            //alert("Load data progressing...");
            $.ajax({
                url: 'https://localhost:7197/api/SaltRequirements',
                type: "GET",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    //alert('Server response: ' + result.message);
                    console.log(result);
                    var html = '';
                    $.each(result.data, function (key, item) {
                        html += '<tr>';
                        html += '<td>' + item.saltId + '</td>';
                        html += '<td>' + item.requiredSaltAmount + '</td>';
                        html += '<td>' + item.notes + '</td>';
                        html += '<td>' + item.createdAt + '</td>';
                        html += '<td>' + item.pond.name + '</td>';
                        html += '<td>' +
                            '<button class="btn btn-info btn-edit" data-id="' + item.saltId + '" onclick="editSalt2(this.getAttribute(\'data-id\'));">Edit</button> ' +
                            '<button id="btDelete" class="btn btn-danger btn-delete" data-id="' + item.saltId + '" onclick="deleteSalt(this.getAttribute(\'data-id\'));">Delete</button>' +
                            '</td>';
                        html += '</tr>';
                    });
                    $('.tblSatls').html(html);
                },
                error: function (xhr, error) {
                    alert(xhr.statusText);
                }
            })
        }
        function add() {
            $("#saltModalContent").html("");
            $("#satlModalLabel").html("Add New");

            $('#saltModal').modal('show');
            populatePondOptions()
        }
        $("#btSave").click(function () {
            $.ajax({
                type: "POST",
                url: 'https://localhost:7197/api/SaltRequirements',
                headers: {
                    'Accept': 'text/plain',
                    'Content-Type': 'application/json; charset=utf-8'
                },
                data: JSON.stringify({
                    satlId: 0,
                    pondId: $("#pond").val(),
                    requiredSaltAmount: $("#requiredSaltAmount").val(),
                    notes: $("#note").val(),
                    createdAt: new Date().toISOString()
                }),
                success: function (result) {
                    if (result.status >= 1) {
                        $('#saltModal').modal('hide');
                        loadData();
                    }
                },
                error: function (xhr, error) {
                    alert("Error: " + xhr.responseText);
                    console.log(xhr);
                }
            });
        });
        $("#btEdit").click(function () {
            var id = $("#saltRequirementId").val();
            console.log("id: ");
            console.log(id);
            $.ajax({
                type: "PUT",
                url: 'https://localhost:7197/api/SaltRequirements',
                headers: {
                    'Accept': 'text/plain',
                    'Content-Type': 'application/json; charset=utf-8'
                },
                data: JSON.stringify({
                    saltId: id,
                    pondId: $("#pond").val(),
                    requiredSaltAmount: $("#requiredSaltAmount").val(),
                    notes: $("#note").val(),
                    createdAt: new Date().toISOString()
                }),
                success: function (result) {
                    if (result.status >= 1) {
                        $('#saltModal').modal('hide');
                        loadData();
                    }
                },
                error: function (xhr, error) {
                    alert("Error: " + xhr.responseText);
                    console.log(xhr);
                }
            });
        });
        function populatePondOptions() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: 'https://localhost:7197/api/Ponds',
                    type: "GET",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {

                        const pondSelect = document.getElementById('pond');
                        pondSelect.innerHTML = '<option value="">Select pond</option>'; 

                        $.each(result.data, function (key, item) {

                            const option = document.createElement('option');
                            option.value = item.pondId; 
                            option.textContent = item.name;
                            pondSelect.appendChild(option);
                        });

                        resolve(); 
                    },
                    error: function (xhr, error) {
                        alert("Error fetching pond data: " + xhr.responseText);
                        reject(error); 
                    }
                });
            });
        }
        function deleteSalt(id) {
            console.log(id)
            if (confirm('Are you sure you want to delete this pond?')) {
                $.ajax({
                    type: "DELETE",
                    url: 'https://localhost:7197/api/SaltRequirements/' + id,
                    success: function (result) {
                        if (result.status >= 1) {
                            alert('Server response: ' + result.message);
                            loadData();
                        }
                    },
                    error: function (xhr, error) {
                        alert("Error: " + xhr.responseText);
                        console.log(xhr);
                    }
                });
            }
        }
        function editSalt(id) {
            var saltId = $(this).data('id');
            editSalt2(saltId); 
        }
        function editSalt2(saltId) {
            console.log(saltId);
            $.ajax({
                url: 'https://localhost:7197/api/SaltRequirements/' + saltId,
                type: "GET",
                success: function (result) {
                    
                    $('#saltModalLabel').text('Edit Salt');
                    $('#btEdit').show();
                    $('#btSave').hide();
                    $('#saltModal').modal('show');
                    $('#requiredSaltAmount').val(result.data.requiredSaltAmount);
                    $('#note').val(result.data.notes);
                    $('#saltRequirementId').val(result.data.saltId);
                    populatePondOptions();
                    $("#pond").attr(result.data.pond.pondId);
                    populatePondOptions();
                },
                error: function (xhr, error) {
                    alert("Error fetching pond data: " + xhr.responseText);
                }
            });
        }

        $(document).ready(function () {
            $('#pondModal').on('show.bs.modal', function () {
                var modalTitle = $('#saltModalLabel').text().trim(); 
                if (modalTitle === 'Edit Salt') {
                    $('#btEdit').show(); 
                    $('#btSave').hide(); 
                } else if (modalTitle === 'Add New Salt') {
                    $('#btSave').show(); // Hiện nút Save
                    $('#btEdit').hide(); // Ẩn nút Edit
                }
            });
        });
    </script>
}